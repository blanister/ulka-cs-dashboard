<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ULKA : CS Dashboard v.0.4.3</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        /* üé® THEME VARIABLES SYSTEM */
        :root {
            /* üåë Dark Mode (Default) */
            --bg-body: #0f172a;
            --bg-mesh: radial-gradient(at 0% 0%, #1e3a8a 0px, transparent 50%), 
                       radial-gradient(at 100% 0%, #1e1b4b 0px, transparent 50%), 
                       radial-gradient(at 100% 100%, #172554 0px, transparent 50%);
            
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(255, 255, 255, 0.1);
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            
            --text-main: #f8fafc;
            --text-secondary: #94a3b8;
            --primary-color: #f97316; /* Orange-500 */
            --primary-glow: rgba(249, 115, 22, 0.4);

            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6; /* Blue for Assigned */

            --font-main: 'Inter', 'Kanit', sans-serif;
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        [data-theme="light"] {
            /* ‚òÄÔ∏è Light Mode */
            --bg-body: #f8fafc; /* Slate-50 */
            --bg-mesh: radial-gradient(at 0% 0%, #fff7ed 0px, transparent 50%), 
                       radial-gradient(at 100% 0%, #ffedd5 0px, transparent 50%);
            
            --card-bg: #ffffff;
            --card-border: #e2e8f0;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            
            --text-main: #1e293b; /* Slate-800 */
            --text-secondary: #64748b; /* Slate-500 */
            --primary-color: #ea580c; /* Orange-600 */
            --primary-glow: rgba(234, 88, 12, 0.2);
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg-body);
            background-image: var(--bg-mesh);
            background-attachment: fixed;
            background-size: cover;
            margin: 0; padding: 20px;
            color: var(--text-main);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            font-size: 14px;
        }

        /* üì± Container & Layout */
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
        }

        /* üíé Glass Card Style */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        /* üîù Header Section */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .header-title { display: flex; flex-direction: column; }
        .header h1 { margin: 0; font-size: 22px; font-weight: 700; color: var(--text-main); letter-spacing: -0.5px; }
        .header-meta { font-size: 12px; color: var(--text-secondary); font-weight: 500; margin-top: 2px; }

        /* üõ† Action Buttons */
        .action-group { display: flex; gap: 10px; align-items: center; }
        .btn-icon {
            width: 42px; height: 42px; border-radius: 50%; border: 1px solid var(--card-border);
            background: var(--card-bg); color: var(--text-main); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; font-size: 18px;
        }
        .btn-icon:hover { background: var(--card-border); transform: translateY(-2px); }
        .btn-icon.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .btn-primary {
            background: var(--primary-color); color: white; border: none; padding: 0 20px; height: 42px;
            border-radius: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px var(--primary-glow);
            transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-family: var(--font-main);
        }
        .btn-primary:hover { transform: translateY(-2px); filter: brightness(1.1); }

        /* üîç Search Bar */
        .search-box {
            position: relative; height: 42px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 42px; overflow: hidden; border-radius: 21px; background: var(--card-bg); border: 1px solid var(--card-border);
        }
        .search-box.expanded { width: 200px; }
        .search-box input {
            width: 100%; height: 100%; background: transparent; border: none; padding: 0 15px 0 45px;
            color: var(--text-main); font-family: var(--font-main); outline: none;
        }
        .search-icon-toggle {
            position: absolute; left: 0; top: 0; width: 42px; height: 42px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2;
        }

        /* üìä Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .leaderboard-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px; }
        
        .lb-card {
            padding: 16px; border-radius: var(--radius-md); position: relative; overflow: hidden;
            cursor: pointer; transition: transform 0.2s; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .lb-card:hover { transform: translateY(-3px); }
        .lb-card h3 { font-size: 11px; margin: 0; opacity: 0.9; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        .lb-card .count { font-size: 28px; font-weight: 800; margin: 4px 0 8px 0; line-height: 1; }
        
        .bg-gradient-all { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        .bg-gradient-1 { background: linear-gradient(135deg, #f43f5e, #e11d48); }
        .bg-gradient-2 { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .bg-gradient-3 { background: linear-gradient(135deg, #f97316, #ea580c); }
        .bg-gradient-4 { background: linear-gradient(135deg, #eab308, #d97706); color: #1e293b; }

        .progress-track { background: rgba(255,255,255,0.2); height: 4px; border-radius: 2px; width: 100%; }
        .progress-fill { background: white; height: 100%; border-radius: 2px; transition: width 0.5s ease; }
        .progress-label { font-size: 10px; font-weight: 600; margin-top: 4px; opacity: 0.9; text-align: right; }

        .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-item {
            background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius-md);
            padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s;
        }
        .stat-item:hover { background: var(--card-border); }
        .stat-item h4 { margin: 0; font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
        .stat-item .val { font-size: 24px; font-weight: 700; color: var(--text-main); margin-top: 5px; }

        /* üéõ Controls */
        .controls-area {
            background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius-md);
            padding: 20px; display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;
        }
        .input-group { flex: 1; min-width: 140px; }
        .input-label { display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; }
        .form-select, .form-input {
            width: 100%; height: 40px; padding: 0 12px; border-radius: 10px;
            border: 1px solid var(--card-border); background: rgba(255,255,255,0.05);
            color: var(--text-main); font-family: var(--font-main); font-size: 13px; outline: none; transition: 0.2s;
        }
        [data-theme="light"] .form-select, [data-theme="light"] .form-input { background: #f1f5f9; }
        .form-select:focus, .form-input:focus { border-color: var(--primary-color); }

        .btn-outline {
            height: 40px; padding: 0 16px; border: 1px solid var(--card-border); background: transparent;
            color: var(--text-secondary); border-radius: 10px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .btn-outline:hover { color: var(--text-main); background: var(--card-border); }

        .chart-container { width: 100%; height: 100%; min-height: 300px; position: relative; }
        .table-container { overflow-x: auto; border-radius: var(--radius-lg); }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { 
            text-align: left; padding: 16px; font-size: 12px; color: var(--text-secondary); 
            text-transform: uppercase; font-weight: 600; border-bottom: 1px solid var(--card-border);
        }
        td { 
            padding: 16px; border-bottom: 1px solid var(--card-border);
            color: var(--text-main); vertical-align: top;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }
        [data-theme="light"] tr:hover td { background: rgba(0,0,0,0.02); }

        /* üåà Status Badges (Updated) */
        .status-badge {
            padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; 
            display: inline-flex; align-items: center; gap: 4px;
        }
        
        /* Green */
        .status-closed { 
            background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); 
        }
        /* Orange/Yellow */
        .status-doing { 
            background: rgba(245, 158, 11, 0.15); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.2); 
        }
        /* Grey */
        .status-pending { 
            background: rgba(148, 163, 184, 0.15); color: #94a3b8; border: 1px solid rgba(148, 163, 184, 0.2); 
        }
        /* Blue (New!) */
        .status-assigned { 
            background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.2); 
        }

        .urgent-badge { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }

        .click-to-copy { cursor: pointer; text-decoration: underline dotted; transition: color 0.2s; }
        .click-to-copy:hover { color: var(--primary-color); }
        .click-to-copy:active { transform: scale(0.98); }

        .copy-toast { 
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); 
            background: rgba(0, 0, 0, 0.85); color: #fff; padding: 10px 20px; 
            border-radius: 20px; font-weight: 700; display: none; z-index: 10000; 
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-family: 'Kanit', sans-serif; 
            font-size: 14px; pointer-events: none;
        }

        /* üö® Ticker */
        .ticker-wrap {
            width: 100%; overflow: hidden; height: 32px; background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px; margin-bottom: 16px;
            display: flex; align-items: center;
        }
        .ticker-content {
            white-space: nowrap; padding-left: 100%; display: inline-block;
            animation: ticker 30s linear infinite; color: var(--danger); font-weight: 600; font-size: 13px;
        }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .leaderboard-row, .stats-row { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; }
            .action-group { width: 100%; justify-content: space-between; margin-top: 10px; }
            .search-box.expanded { width: 100%; position: absolute; left: 0; right: 0; top: 70px; z-index: 10; padding: 0 10px; }
            .leaderboard-row { grid-template-columns: 1fr 1fr; }
            .card-all { grid-column: span 2; }
            .stats-row { grid-template-columns: repeat(3, 1fr); }
            .chart-container { min-height: 250px; }
            .controls-area { flex-direction: column; align-items: stretch; }
            .btn-outline, .btn-primary { width: 100%; justify-content: center; }
        }

        .loading-bar { position: fixed; top: 0; left: 0; height: 3px; background: var(--primary-color); width: 0%; z-index: 9999; transition: width 0.5s linear; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 1000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-box {
            background: var(--bg-body); border: 1px solid var(--card-border); width: 90%; max-width: 500px;
            border-radius: var(--radius-lg); padding: 30px; box-shadow: var(--card-shadow); max-height: 90vh; overflow-y: auto;
        }
    </style>
</head>
<body>

<div class="loading-bar" id="refreshBar"></div>
<div id="copyToast" class="copy-toast">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß! üìã</div>

<div class="container">
    
    <header class="glass-card header">
        <div class="header-title">
            <h1>CS Dashboard</h1>
            <span class="header-meta" id="countdown">v.0.4.3 ‚Ä¢ Updated just now</span>
        </div>
        
        <div class="action-group">
            <div class="search-box" id="searchBox">
                <div class="search-icon-toggle" onclick="toggleSearch()">üîç</div>
                <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." onkeyup="renderTable()">
            </div>
            
            <button class="btn-icon" id="btnLine" onclick="toggleChannel('Line OA', this)">L</button>
            <button class="btn-icon" id="btnFb" onclick="toggleChannel('Facebook', this)">F</button>
            <button class="btn-icon" onclick="toggleTheme()">üåì</button>
            <button class="btn-primary" onclick="openModal()"><span>+ ‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà</span></button>
        </div>
    </header>

    <div id="urgentTicker" class="ticker-wrap" style="display:none;">
        <div class="ticker-content" id="tickerContent"></div>
    </div>

    <div class="dashboard-grid">
        <div style="display: flex; flex-direction: column; gap: 20px;">
            
            <div class="leaderboard-row" id="leaderboard"></div>

            <div class="stats-row">
                <div class="stat-item" onclick="filterStatus('total-all')"><h4>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4><div class="val" id="val-total">0</div></div>
                <div class="stat-item" onclick="filterStatus('all')"><h4>‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</h4><div class="val" id="val-active" style="color:var(--primary-color)">0</div></div>
                <div class="stat-item" onclick="filterStatus('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')"><h4>‡∏£‡∏≠</h4><div class="val" id="val-pending">0</div></div>
                <div class="stat-item" onclick="filterStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')"><h4>‡∏ó‡∏≥</h4><div class="val" id="val-doing">0</div></div>
                <div class="stat-item" onclick="filterStatus('‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™')"><h4>‡∏õ‡∏¥‡∏î</h4><div class="val" id="val-closed" style="color:var(--success)">0</div></div>
            </div>

            <div class="controls-area">
                <div class="input-group">
                    <label class="input-label">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" id="dateFilter" class="form-input" onchange="renderTable()">
                </div>
                <div class="input-group" style="flex:0.5; display:flex; align-items:flex-end;">
                     <label style="cursor:pointer; display:flex; align-items:center; gap:8px; height:40px;">
                        <input type="checkbox" id="monthToggle" onchange="renderTable()">
                        <span style="font-size:13px; font-weight:500;">‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                     </label>
                </div>
                <div class="input-group">
                    <label class="input-label">‚ö° ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <select id="statusFilter" class="form-select" onchange="renderTable()">
                        <option value="total-all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="all" selected>‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á (Active)</option>
                        <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                        <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (‡∏£‡∏ß‡∏°‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢)</option>
                        <option value="‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™">‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">üë§ ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</label>
                    <select id="csFilter" class="form-select" onchange="renderTable()">
                        <option value="all">‡∏ó‡∏µ‡∏°‡∏£‡∏ß‡∏°</option>
                        <option value="Best">Best</option>
                        <option value="Friend">Friend</option>
                        <option value="Ball">Ball</option>
                        <option value="Ohm">Ohm</option>
                    </select>
                </div>
                <button class="btn-outline" onclick="resetFilters()">‚Ü∫ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                <button class="btn-outline" onclick="exportCSV()">üì• Export</button>
            </div>
        </div>

        <div class="glass-card" style="padding: 20px; display:flex; flex-direction:column;">
            <h3 style="margin:0 0 15px 0; font-size:14px; color:var(--text-secondary);">üèÜ Top 10 Models</h3>
            <div id="chart_div" class="chart-container"></div>
        </div>
    </div>

    <div class="glass-card table-container">
        <table id="mainTable">
            <thead>
                <tr>
                    <th>#</th><th>Ticket</th><th>Date</th><th>Customer</th><th>Model / Type</th>
                    <th>Issue</th><th>Solution</th><th>Owner</th><th>Urgency</th><th>Status</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div class="modal-overlay" id="addModal">
    <div class="modal-box">
        <h2 style="margin-top:0;">üìÇ ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà</h2>
        <form id="ticketForm" style="display:flex; flex-direction:column; gap:15px;">
            <div><label class="input-label">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
            <select name="owner" class="form-select" required><option value="Best">Best</option><option value="Friend">Friend</option><option value="Ball">Ball</option><option value="Ohm">Ohm</option></select></div>
            <div><label class="input-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input name="customerName" class="form-input" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..."></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><label class="input-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select name="type" class="form-select"><option value="ICE">ICE</option><option value="COFFEE">COFFEE</option><option value="FUME">FUME</option><option value="BLENDER">BLENDER</option><option value="SODA">SODA</option><option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥</option><option value="‡∏õ‡∏±‡πä‡∏°‡∏î‡∏π‡∏î‡∏ô‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ñ‡∏±‡∏á">‡∏õ‡∏±‡πä‡∏°‡∏î‡∏π‡∏î‡∏ô‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ñ‡∏±‡∏á</option><option value="‡∏ï‡∏π‡πâ‡πÅ‡∏ä‡πà‡∏ô‡∏°">‡∏ï‡∏π‡πâ‡πÅ‡∏ä‡πà‡∏ô‡∏°</option></select></div>
                <div><label class="input-label">‡∏£‡∏∏‡πà‡∏ô</label><select name="model" class="form-select">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô --</option><option value="12A">12A</option><option value="12B">12B</option><option value="12C">12C</option><option value="15AF">15AF</option><option value="RoG600">RoG600</option><option value="S72C">S72C</option><option value="006C/H">006C/H</option><option value="S9C">S9C</option><option value="07S">07S</option><option value="38F">38F</option><option value="20AF">20AF</option><option value="120F">120F</option><option value="13F-W">13F-W</option><option value="P3B">P3B</option><option value="ProSoda">ProSoda</option><option value="Pro soda max">Pro soda max</option><option value="65S">65S</option><option value="45F">45F</option><option value="ROA4">ROA4</option><option value="U5">U5</option><option value="13F-PS">13F-PS</option><option value="220F">220F</option><option value="700xj">700xj</option><option value="FE 401">FE 401</option><option value="15SA">15SA</option><option value="13F-WB">13F-WB</option><option value="190F">190F</option><option value="20YLR">20YLR</option><option value="Blender">Blender</option><option value="ro-g600">ro-g600</option><option value="M7A">M7A</option><option value="RoA4">RoA4</option><option value="9CN">9CN</option><option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</option>
                </select></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><label class="input-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</label><select name="urgency" class="form-select"><option value="3.‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏ö">‡∏õ‡∏Å‡∏ï‡∏¥</option><option value="2.‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option><option value="1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å">üî• ‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option></select></div>
                <div><label class="input-label">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label><select name="channel" class="form-select"><option value="Line OA">Line OA</option><option value="Facebook">Facebook</option><option value="Shopee">Shopee</option><option value="‡πÇ‡∏ó‡∏£">‡πÇ‡∏ó‡∏£</option></select></div>
            </div>
            <div><label class="input-label">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label><textarea name="issue" class="form-input" style="height:80px; padding-top:10px;"></textarea></div>
            <div><label class="input-label">‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label><textarea name="solution" class="form-input" style="height:60px; padding-top:10px;"></textarea></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button type="submit" class="btn-primary" style="flex:1; justify-content:center;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button type="button" class="btn-outline" style="flex:1; justify-content:center;" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </form>
    </div>
</div>

<script>
    google.charts.load('current', {'packages':['corechart']});
    const SHEET_ID = '1yP4soDSWwjomPVP3_udd2m3SZlm5j5XVo32tbKGvwdA', SHEET_GID = '816388223';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzDRJpLUw51hZi3WI6Su7_LgeXz0GG-bK4CtfGygkmbfne2dMdtbVAVjD0NDmuEaL8v/exec';

    let allTickets = [], filteredExport = [];
    let currentChannel = 'all';
    let countdownSec = 300;
    const savedTheme = localStorage.getItem('cs_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);

    function toggleTheme() {
        const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next); localStorage.setItem('cs_theme', next);
        drawChart(allTickets);
    }
    function toggleSearch() { document.getElementById('searchBox').classList.toggle('expanded'); document.getElementById('searchInput').focus(); }
    function toggleChannel(ch, btn) {
        currentChannel = currentChannel === ch ? 'all' : ch;
        document.querySelectorAll('.btn-icon').forEach(b => b.classList.remove('active'));
        if(currentChannel !== 'all') btn.classList.add('active');
        renderTable();
    }
    function openModal() { document.getElementById('addModal').classList.add('open'); }
    function closeModal() { document.getElementById('addModal').classList.remove('open'); }
    function filterStatus(s) { document.getElementById('statusFilter').value = s; renderTable(); }
    function filterOwner(o) { document.getElementById('csFilter').value = o || 'all'; renderTable(); }
    function resetFilters() {
        document.getElementById('dateFilter').value = ''; document.getElementById('monthToggle').checked = false;
        document.getElementById('statusFilter').value = 'all'; document.getElementById('csFilter').value = 'all';
        currentChannel = 'all'; document.querySelectorAll('.btn-icon').forEach(b => b.classList.remove('active'));
        renderTable();
    }
    function copyCustomerName(name) {
        navigator.clipboard.writeText(name).then(() => {
            const t = document.getElementById('copyToast'); t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2000);
        });
    }

    setInterval(() => {
        if(countdownSec > 0) {
            countdownSec--;
            let m = Math.floor(countdownSec/60).toString().padStart(2,'0'), s = (countdownSec%60).toString().padStart(2,'0');
            document.getElementById('countdown').innerText = `v.0.4.3 ‚Ä¢ Auto Refresh in ${m}:${s}`;
            document.getElementById('refreshBar').style.width = ((300-countdownSec)/300)*100 + "%";
        } else location.reload();
    }, 1000);

    const script = document.createElement('script');
    script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:handleData&gid=${SHEET_GID}`;
    document.body.appendChild(script);

    window.handleData = (json) => {
        const rows = json.table.rows;
        allTickets = rows.map(r => {
            const v = (i) => (r.c[i] ? (r.c[i].f || r.c[i].v) : "-");
            return {
                id: v(0), date: v(1), owner: v(2), urgent: v(3), status: v(4), assignee: v(5),
                channel: v(6), customer: v(11), issue: v(20), solution: v(13), model: v(15), type: v(14)
            };
        }).filter(x => x.id !== 'Ticket ID' && x.id !== '-');

        allTickets.sort((a,b) => {
            const pMap = {'1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å':1, '2.‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á':2, '3.‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏ö':3};
            const sMap = {'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£':1, '‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢':2, '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£':3, '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™':4};
            if(pMap[a.urgent] !== pMap[b.urgent]) return (pMap[a.urgent]||99) - (pMap[b.urgent]||99);
            return (sMap[a.status]||99) - (sMap[b.status]||99);
        });
        updateDashboard(); renderTable();
    };

    function updateDashboard() {
        const stats = { total:0, active:0, pending:0, doing:0, closed:0 };
        const team = { 'Best':{t:0,c:0}, 'Friend':{t:0,c:0}, 'Ball':{t:0,c:0}, 'Ohm':{t:0,c:0} };
        const allTeam = { t:0, c:0 };
        let tickerText = "";

        allTickets.forEach(t => {
            const isClosed = t.status.includes('‡∏õ‡∏¥‡∏î');
            stats.total++;
            if(isClosed) stats.closed++;
            else {
                stats.active++;
                if(t.status.includes('‡∏£‡∏≠')) stats.pending++;
                else stats.doing++;
            }
            if(team[t.owner]) { team[t.owner].t++; if(isClosed) team[t.owner].c++; }
            allTeam.t++; if(isClosed) allTeam.c++;
            if(t.urgent.includes('1') && !isClosed) tickerText += `üî• [${t.id}] ${t.customer} (${t.issue}) &nbsp;&nbsp;&nbsp; `;
        });

        document.getElementById('val-total').innerText = stats.total;
        document.getElementById('val-active').innerText = stats.active;
        document.getElementById('val-pending').innerText = stats.pending;
        document.getElementById('val-doing').innerText = stats.doing;
        document.getElementById('val-closed').innerText = stats.closed;

        if(tickerText) { document.getElementById('urgentTicker').style.display = 'flex'; document.getElementById('tickerContent').innerHTML = tickerText; }

        const lb = document.getElementById('leaderboard'); lb.innerHTML = '';
        const allPct = allTeam.t ? Math.round((allTeam.c/allTeam.t)*100) : 0;
        lb.innerHTML += createLBCard('ALL', allTeam.t, allTeam.c, allPct, 'bg-gradient-all', null);
        let i = 1;
        for(const [name, s] of Object.entries(team)) {
            const pct = s.t ? Math.round((s.c/s.t)*100) : 0;
            lb.innerHTML += createLBCard(name, s.t, s.c, pct, `bg-gradient-${i}`, name); i++;
        }
        drawChart(allTickets);
    }

    function createLBCard(title, total, closed, pct, bgClass, filterName) {
        const onClick = filterName ? `onclick="filterOwner('${filterName}')"` : `onclick="filterOwner(null)"`;
        return `<div class="lb-card ${bgClass}" ${onClick}><h3>${title}</h3><div class="count">${total}</div><div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div><div class="progress-label">${pct}% Closed</div></div>`;
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
        const search = document.getElementById('searchInput').value.toLowerCase();
        const sFilter = document.getElementById('statusFilter').value;
        const cFilter = document.getElementById('csFilter').value;
        const dFilter = document.getElementById('dateFilter').value;
        const mFilter = document.getElementById('monthToggle').checked;

        const filtered = allTickets.filter(t => {
            if(dFilter) {
                const tDate = parseDate(t.date);
                if(mFilter) { if(!tDate.startsWith(dFilter.slice(0,7))) return false; }
                else { if(tDate !== dFilter) return false; }
            }
            if(sFilter !== 'total-all') {
                if(sFilter === 'all' && t.status.includes('‡∏õ‡∏¥‡∏î')) return false;
                if(sFilter === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && !t.status.includes('‡∏£‡∏≠')) return false;
                if(sFilter === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && (!t.status.includes('‡∏Å‡∏≥‡∏•‡∏±‡∏á') && !t.status.includes('‡∏°‡∏≠‡∏ö'))) return false;
                if(sFilter === '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™' && !t.status.includes('‡∏õ‡∏¥‡∏î')) return false;
            }
            if(cFilter !== 'all' && t.owner !== cFilter) return false;
            if(currentChannel !== 'all' && !t.channel.includes(currentChannel)) return false;
            if(search && !JSON.stringify(t).toLowerCase().includes(search)) return false;
            return true;
        });

        filteredExport = filtered;
        if(filtered.length === 0) { tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:30px; opacity:0.5;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }

        filtered.forEach((t, i) => {
            const uCol = t.urgent.includes('1') ? '#ef4444' : (t.urgent.includes('2') ? '#f59e0b' : '#3b82f6');
            
            // üé® NEW COLOR LOGIC
            let sClass = 'status-pending'; // Default Grey
            if(t.status.includes('‡∏õ‡∏¥‡∏î')) sClass = 'status-closed'; // Green
            else if(t.status.includes('‡∏Å‡∏≥‡∏•‡∏±‡∏á')) sClass = 'status-doing'; // Orange
            else if(t.status.includes('‡∏°‡∏≠‡∏ö') || t.status.includes('‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠')) sClass = 'status-assigned'; // Blue (New!)

            tbody.innerHTML += `<tr><td>${i+1}</td><td style="font-weight:600; color:var(--primary-color)">${t.id}</td><td>${t.date}</td><td style="font-weight:600;"><span class="click-to-copy" onclick="copyCustomerName(this.innerText)" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å">${t.customer}</span></td><td><div style="font-weight:600;">${t.model}</div><small style="opacity:0.6">${t.type}</small></td><td style="max-width:200px;">${t.issue}</td><td style="max-width:200px;">${t.solution}</td><td>${t.owner}</td><td><span class="urgent-badge" style="background:${uCol}"></span>${t.urgent.split('.')[1]||t.urgent}</td><td><span class="status-badge ${sClass}">${t.status}</span></td></tr>`;
        });
    }

    function parseDate(str) {
        if(!str || str==='-') return '';
        let d, m, y;
        if(str.includes('Date')) { const ts = parseInt(str.match(/\d+/)[0]), date = new Date(ts); y=date.getFullYear(); m=date.getMonth()+1; d=date.getDate(); }
        else { const p = str.split(/[\/\-\.]/); if(p.length<3) return str; if(p[0].length===4) {y=p[0];m=p[1];d=p[2];} else {d=p[0];m=p[1];y=p[2];} }
        if(y>2400) y-=543; return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }

    function drawChart(data) {
        const counts = {}; data.forEach(t => { if(t.model && t.model!=='-') counts[t.model] = (counts[t.model]||0)+1; });
        const cData = [['Model','Count']]; Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10).forEach(x => cData.push(x));
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        new google.visualization.PieChart(document.getElementById('chart_div')).draw(google.visualization.arrayToDataTable(cData), {
            backgroundColor: 'transparent', pieHole: 0.5, legend: { position: 'right', textStyle: { color: isDark ? '#cbd5e1' : '#334155', fontName:'Inter', fontSize:12 } },
            chartArea: { left:10, top:10, width:'90%', height:'90%' }, pieSliceBorderColor: 'transparent', sliceVisibilityThreshold: 0
        });
    }

    function exportCSV() {
        let csv = "ID,Date,Customer,Model,Issue,Solution,Owner,Status\n";
        filteredExport.forEach(r => csv += `"${r.id}","${r.date}","${r.customer}","${r.model}","${r.issue}","${r.solution}","${r.owner}","${r.status}"\n`);
        const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = "CS_Report.csv"; link.click();
    }

    document.getElementById('ticketForm').onsubmit = function(e) {
        e.preventDefault(); const btn = this.querySelector('button[type="submit"]'), oldText = btn.innerText; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; btn.disabled = true;
        fetch(SCRIPT_URL, { method: 'POST', body: new URLSearchParams(new FormData(this)), mode: 'no-cors' }).then(() => location.reload()).catch(() => { alert('Error!'); btn.innerText = oldText; btn.disabled = false; });
    };
</script>
</body>
</html>
