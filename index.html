<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="tabTitle">ULKA : CS Dashboard v.0.0.5.8</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
            --primary: #003399;
            --accent: #007aff;
            --text: #1d1d1f;
            --bg-mesh: radial-gradient(at 0% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                       radial-gradient(at 50% 0%, hsla(225,39%,20%,1) 0, transparent 50%), 
                       radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            --danger: #d63031;
        }

        [data-theme="dark"] {
            --glass: rgba(15, 15, 25, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --primary: #64d2ff;
            --accent: #5ac8fa;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-image: var(--bg-mesh);
            background-attachment: fixed;
            margin: 0; padding: 15px;
            color: var(--text);
            min-height: 100vh;
            transition: 0.3s;
        }

        .container { max-width: 1450px; margin: 0 auto; }
        .glass-panel { background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid var(--glass-border); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }

        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .header h2 { margin: 0; font-size: 20px; color: var(--primary); font-weight: 600; }

        .refresh-bar-container { width: 100%; height: 4px; background: rgba(0,0,0,0.1); margin-bottom: 15px; border-radius: 10px; overflow: hidden; }
        #refreshBar { width: 0%; height: 100%; background: var(--primary); transition: width 1s linear; }

        .main-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px; }
        @media (min-width: 1000px) { .main-grid { grid-template-columns: 2fr 1.2fr; } }

        .leaderboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        @media (min-width: 600px) { .leaderboard-grid { grid-template-columns: repeat(4, 1fr); } }
        
        .person-card { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 18px; border: none; transition: 0.3s; color: white; }
        .card-best { background: #d63031; box-shadow: 0 4px 15px rgba(214, 48, 49, 0.3); }
        .card-friend { background: #0984e3; box-shadow: 0 4px 15px rgba(9, 132, 227, 0.3); }
        .card-ball { background: #e67e22; box-shadow: 0 4px 15px rgba(230, 126, 34, 0.3); }
        .card-ohm { background: #f1c40f; box-shadow: 0 4px 15px rgba(241, 196, 15, 0.3); color: #000; }
        
        .person-name { font-weight: 800; font-size: 16px; text-transform: uppercase; }
        .person-count { font-size: 28px; font-weight: 900; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        @media (min-width: 1000px) { .stats-grid { grid-template-columns: repeat(4, 1fr); margin-bottom: 15px; } }
        .stat-card { padding: 15px; text-align: center; cursor: pointer; }
        .stat-card h3 { font-size: 12px; margin: 0; opacity: 0.7; }
        .stat-card .value { font-size: 28px; font-weight: 600; margin-top: 5px; color: var(--text); }

        .controls { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .search-box { flex-grow: 1; padding: 12px 20px; border-radius: 15px; border: 1px solid var(--glass-border); background: var(--glass); color: var(--text); outline: none; font-size: 14px; }
        .filter-btn { background: var(--glass); border: 1px solid var(--glass-border); padding: 8px 15px; border-radius: 12px; cursor: pointer; color: var(--text); font-weight: 600; font-size: 13px; }
        .filter-btn.active { background: var(--primary); color: #000; }

        .table-wrap { padding: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 1200px; border-collapse: collapse; } 
        @media (min-width: 1200px) { table { width: 100%; table-layout: fixed; } }
        
        th { padding: 12px 8px; text-align: left; font-size: 12px; border-bottom: 2px solid var(--glass-border); color: var(--primary); font-weight: 600; }
        td { padding: 12px 8px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text); vertical-align: top; }

        /* üìã Copy Feature Styles */
        .copyable-name { cursor: pointer; color: var(--accent); font-weight: 600; position: relative; padding: 2px 4px; border-radius: 4px; transition: 0.2s; }
        .copyable-name:active { background: rgba(0,122,255,0.2); transform: scale(0.95); }
        .copy-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; font-size: 14px; z-index: 10000; display: none; }

        .key-highlight { color: var(--danger); font-weight: bold; text-decoration: underline; }
        .badge { padding: 4px 6px; border-radius: 8px; font-size: 10px; font-weight: 600; color: #fff; text-align: center; display: block; }
        .u-vhigh { background: #ff3b30; } .u-medium { background: #ff9500; } .u-low { background: #007aff; }
        .status-closed { background: #34c759; } .status-process { background: #ffcc00; color: #000; } .status-pending { background: #8e8e93; }

        .btn-add { background: var(--primary); color: #000; border: none; padding: 10px 20px; border-radius: 14px; font-weight: 700; cursor: pointer; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); z-index: 9999; overflow-y: auto; }
        .modal-content { background: var(--glass); margin: 20px auto; padding: 25px; width: 90%; max-width: 600px; border-radius: 25px; border: 1px solid var(--glass-border); }
        input, select, textarea { width:100%; padding:10px; border-radius:10px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.2); color: var(--text); font-family: 'Sarabun'; font-size: 16px; box-sizing: border-box; margin-top: 5px; }

        #chart_div { width: 100%; height: 220px; }

        @media (min-width: 1200px) {
            th:nth-child(1), td:nth-child(1) { width: 35px; } th:nth-child(2), td:nth-child(2) { width: 65px; }
            th:nth-child(3), td:nth-child(3) { width: 75px; } th:nth-child(4), td:nth-child(4) { width: 75px; }
            th:nth-child(5), td:nth-child(5) { width: 110px; } th:nth-child(6), td:nth-child(6) { width: 100px; }
            th:nth-child(7), td:nth-child(7) { width: 19%; } th:nth-child(8), td:nth-child(8) { width: 19%; }
            th:nth-child(9), td:nth-child(9) { width: 70px; } th:nth-child(10), td:nth-child(10) { width: 90px; }
            th:nth-child(11), td:nth-child(11) { width: 90px; } th:nth-child(12), td:nth-child(12) { width: 80px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="glass-panel header">
        <h2>üìä ULKA : CS Dashboard <span style="font-size:10px; opacity:0.5;">v.0.0.5.8 Alpha</span></h2>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div id="countdownText" style="font-size: 12px; font-weight: 600;">05:00</div>
            <button class="btn-add" onclick="openAddModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏™</button>
            <button onclick="toggleTheme()" class="filter-btn" id="themeBtn">‚òÄ</button>
        </div>
    </div>
    
    <div class="refresh-bar-container"><div id="refreshBar"></div></div>

    <div class="main-grid">
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div class="leaderboard-grid" id="csLeaderboard"></div>
            <div class="stats-grid">
                <div class="glass-panel stat-card" onclick="setQuickFilter('all')"><h3>‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</h3><div class="value" id="totalTickets">0</div></div>
                <div class="glass-panel stat-card" onclick="setQuickFilter('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')"><h3>üî¥ ‡∏£‡∏≠</h3><div class="value" id="pendingTickets">0</div></div>
                <div class="glass-panel stat-card" onclick="setQuickFilter('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')"><h3>üü° ‡∏ó‡∏≥</h3><div class="value" id="processTickets">0</div></div>
                <div class="glass-panel stat-card" onclick="setQuickFilter('‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™')"><h3>üü¢ ‡∏õ‡∏¥‡∏î</h3><div class="value" id="closedTickets">0</div></div>
            </div>
        </div>
        <div class="glass-panel" style="padding: 10px;">
            <div id="chart_div"></div>
        </div>
    </div>

    <div class="controls">
        <input type="text" id="searchInput" class="glass-panel search-box" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á..." onkeyup="applyFilters()">
        <button class="filter-btn" onclick="toggleChannelFilter('Line OA', this)">üü¢ Line</button>
        <button class="filter-btn" onclick="toggleChannelFilter('Facebook', this)">üìò FB</button>
    </div>

    <div class="glass-panel table-wrap">
        <table>
            <thead><tr><th>#</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡πä‡∏≠‡∏õ)</th><th>‡∏£‡∏∏‡πà‡∏ô</th><th>‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th><th>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th><th>CS</th><th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="copyToast" class="copy-toast">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß! üìã</div>

<div id="addModal" class="modal">
    <div class="modal-content glass-panel">
        <h2 style="margin:0 0 20px 0; color:var(--primary); font-size: 18px;">üìÇ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà</h2>
        <form id="ticketForm">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div style="grid-column: span 2;"><label>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
                    <select name="owner" id="ownerSelect" required onchange="savePreferredOwner()">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                        <option value="Best">Best</option><option value="Friend">Friend</option><option value="Ball">Ball</option><option value="Ohm">Ohm</option>
                    </select>
                </div>
                <div><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</label><select name="urgency"><option value="1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å">1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option><option value="2.‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á">2.‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option><option value="3.‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏ö" selected>3.‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏ö</option></select></div>
                <div><label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label><select name="channel" required><option value="Line OA">Line OA</option><option value="Facebook">Facebook</option><option value="Shopee">Shopee</option><option value="‡πÇ‡∏ó‡∏£">‡πÇ‡∏ó‡∏£</option></select></div>
                <div style="grid-column: span 2;"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input name="customerName" required placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"></div>
                <div><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <select name="type" required>
                        <option value="ICE">ICE</option><option value="COFFEE">COFFEE</option><option value="FUME">FUME</option><option value="BLENDER">BLENDER</option><option value="SODA">SODA</option><option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥</option><option value="‡∏õ‡∏±‡πä‡∏°‡∏î‡∏π‡∏î‡∏ô‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ñ‡∏±‡∏á">‡∏õ‡∏±‡πä‡∏°‡∏î‡∏π‡∏î‡∏ô‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ñ‡∏±‡∏á</option><option value="‡∏ï‡∏π‡πâ‡πÅ‡∏ä‡πà‡∏ô‡∏°">‡∏ï‡∏π‡πâ‡πÅ‡∏ä‡πà‡∏ô‡∏°</option>
                    </select>
                </div>
                <div><label>‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <select name="model" required>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                        <option value="12A">12A</option><option value="12B">12B</option><option value="12C">12C</option><option value="15AF">15AF</option><option value="RoG600">RoG600</option><option value="S72C">S72C</option><option value="006C/H">006C/H</option><option value="S9C">S9C</option><option value="07S">07S</option><option value="38F">38F</option><option value="20AF">20AF</option><option value="120F">120F</option><option value="13F-W">13F-W</option><option value="P3B">P3B</option><option value="ProSoda">ProSoda</option><option value="Pro soda max">Pro soda max</option><option value="65S">65S</option><option value="45F">45F</option><option value="ROA4">ROA4</option><option value="U5">U5</option><option value="13F-PS">13F-PS</option><option value="220F">220F</option><option value="700xj">700xj</option><option value="FE 401">FE 401</option><option value="15SA">15SA</option><option value="13F-WB">13F-WB</option><option value="190F">190F</option><option value="20YLR">20YLR</option><option value="Blender">Blender</option><option value="ro-g600">ro-g600</option><option value="M7A">M7A</option><option value="RoA4">RoA4</option><option value="9CN">9CN</option><option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</option>
                    </select>
                </div>
                <div style="grid-column: span 2;"><label>‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</label><textarea name="issue" rows="2" placeholder="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô"></textarea></div>
                <div style="grid-column: span 2;"><label>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label><textarea name="solution" rows="2" placeholder="‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"></textarea></div>
            </div>
            <button type="submit" id="submitBtn" class="btn-add" style="width:100%; margin-top:20px; padding:15px; color:#fff;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏µ‡∏ï</button>
            <button type="button" onclick="document.getElementById('addModal').style.display='none'" style="width:100%; margin-top:10px; opacity:0.5; border:none; background:none; cursor:pointer; color:inherit;">‚úñ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </form>
    </div>
</div>

<script>
    google.charts.load('current', {'packages':['corechart']});
    const REFRESH_TIME = 300; let countdown = REFRESH_TIME;
    const SHEET_ID = '1yP4soDSWwjomPVP3_udd2m3SZlm5j5XVo32tbKGvwdA';
    const SHEET_GID = '816388223'; 
    let allTickets = [], currentQuickFilter = 'all', currentChannelFilter = 'all';

    // üü¢ ‡∏£‡∏∞‡∏ö‡∏ö Copy ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    function copyCustomerName(name) {
        navigator.clipboard.writeText(name).then(() => {
            const toast = document.getElementById('copyToast');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        });
    }

    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.body.setAttribute('data-theme', savedTheme);
    document.getElementById('themeBtn').innerText = savedTheme === 'dark' ? '‚òæ' : '‚òÄ';

    function toggleTheme() {
        const t = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', t);
        document.getElementById('themeBtn').innerText = t === 'dark' ? '‚òæ' : '‚òÄ';
        localStorage.setItem('theme', t);
        renderTable(allTickets); 
    }

    function openAddModal() {
        document.getElementById('ticketForm').reset();
        const preferred = localStorage.getItem('preferredOwner');
        if (preferred) document.getElementById('ownerSelect').value = preferred;
        document.getElementById('addModal').style.display = 'block';
    }

    function savePreferredOwner() { localStorage.setItem('preferredOwner', document.getElementById('ownerSelect').value); }

    function startCountdown() {
        setInterval(() => {
            countdown--;
            const min = Math.floor(countdown / 60), sec = countdown % 60;
            document.getElementById('countdownText').innerText = `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
            document.getElementById('refreshBar').style.width = ((REFRESH_TIME - countdown) / REFRESH_TIME) * 100 + "%";
            if (countdown <= 0) location.reload();
        }, 1000);
    }

    window.handleGoogleResponse = (json) => {
        allTickets = json.table.rows.map((row) => {
            const getV = (i) => (row.c[i] && (row.c[i].f || row.c[i].v)) ? (row.c[i].f || row.c[i].v) : "-";
            return { 
                ticketId: getV(0), date: getV(1), owner: getV(2), urgent: getV(3), 
                status: getV(4), assignee: getV(5), channel: getV(6), 
                customer: getV(11), solution: getV(13), type: getV(14), model: getV(15), issue: getV(20) 
            };
        }).filter(it => it.ticketId !== "-" && it.ticketId !== "Ticket ID");
        
        allTickets.sort((a, b) => {
            const p = { "1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å": 1, "2.‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á": 2, "3.‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏ö": 3 };
            const priorityDiff = (p[a.urgent] || 99) - (p[b.urgent] || 99);
            if (priorityDiff !== 0) return priorityDiff;
            const s = { "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£": 1, "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£": 2, "‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™": 3 };
            return (s[a.status] || 99) - (s[b.status] || 99);
        });
        renderTable(allTickets);
        startCountdown();
    };

    function drawChart(data) {
        const modelCounts = {};
        data.forEach(r => { if(r.model !== "-" && r.model !== "") modelCounts[r.model] = (modelCounts[r.model] || 0) + 1; });
        const sortedModels = Object.entries(modelCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
        const chartData = [['Model', 'Count']];
        sortedModels.forEach(([m, c]) => chartData.push([m, c]));
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        const options = {
            title: '10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡∏Å‡∏°‡∏≤‡∏ö‡πà‡∏≠‡∏¢',
            pieHole: 0.4,
            backgroundColor: 'transparent',
            legend: { textStyle: { color: isDark ? '#fff' : '#000', fontSize: 10 } },
            titleTextStyle: { color: isDark ? '#fff' : '#000', fontSize: 13, bold: true },
            chartArea: { width: '90%', height: '80%' },
            colors: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8AC926', '#1982C4', '#6A4C93', '#FF595E']
        };
        const chart = new google.visualization.PieChart(document.getElementById('chart_div'));
        chart.draw(google.visualization.arrayToDataTable(chartData), options);
    }

    function renderTable(data) {
        const tbody = document.getElementById("tableBody"); tbody.innerHTML = "";
        let stats = { t:0, p:0, pr:0, c:0 };
        let csStats = { "Best": 0, "Friend": 0, "Ball": 0, "Ohm": 0 };

        allTickets.forEach(r => {
            const isClosed = r.status.includes("‡∏õ‡∏¥‡∏î");
            if(r.status.includes("‡∏£‡∏≠")) stats.p++; else if(r.status.includes("‡∏î‡∏≥")) stats.pr++; else if(isClosed) stats.c++;
            if(!isClosed) { stats.t++; if(csStats.hasOwnProperty(r.owner)) csStats[r.owner]++; }
        });

        const nameClassMap = { "Best": "card-best", "Friend": "card-friend", "Ball": "card-ball", "Ohm": "card-ohm" };
        document.getElementById('csLeaderboard').innerHTML = Object.entries(csStats).map(([name, count]) => `
            <div class="person-card ${nameClassMap[name] || ''}">
                <span class="person-name">${name}</span>
                <span class="person-count">${count}</span>
            </div>
        `).join('');
        
        drawChart(allTickets);

        let display = data.filter(r => {
            const matchChannel = (currentChannelFilter==='all') ? true : r.channel.includes(currentChannelFilter);
            const matchSearch = Object.values(r).some(v => String(v).toLowerCase().includes(document.getElementById("searchInput").value.toLowerCase()));
            const matchStatus = (currentQuickFilter === 'all') ? !r.status.includes("‡∏õ‡∏¥‡∏î") : r.status.includes(currentQuickFilter);
            return matchStatus && matchChannel && matchSearch;
        });
        
        display.forEach((r, i) => {
            const dangerousTerms = ["‡∏£‡∏±‡πà‡∏ß", "‡∏ä‡πá‡∏≠‡∏ï", "‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î", "‡∏Ñ‡∏∑‡∏ô", "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô", "‡∏Ñ‡∏ß‡∏±‡∏ô", "‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ"];
            let highlightedIssue = r.issue;
            dangerousTerms.forEach(term => highlightedIssue = highlightedIssue.replace(new RegExp(term, "g"), `<span class="key-highlight">${term}</span>`));

            tbody.innerHTML += `<tr>
                <td style="opacity:0.4">${i+1}</td>
                <td style="font-weight:600; color:var(--primary)">${r.ticketId}</td>
                <td>${r.date}</td><td>${r.channel}</td>
                <td><span class="copyable-name" onclick="copyCustomerName('${r.customer}')">${r.customer} üìã</span></td>
                <td><b>${r.model}</b><br><small style="opacity:0.7">${r.type}</small></td>
                <td>${highlightedIssue}</td><td style="color:#27ae60">${r.solution}</td>
                <td>${r.owner}</td>
                <td><span class="badge ${r.urgent.includes("1")?"u-vhigh":r.urgent.includes("2")?"u-medium":"u-low"}">${r.urgent}</span></td>
                <td><span class="badge ${r.status.includes("‡∏õ‡∏¥‡∏î")?"status-closed":r.status.includes("‡∏î‡∏≥")?"status-process":"status-pending"}">${r.status}</span></td>
                <td>${r.assignee}</td>
            </tr>`;
        });
        document.getElementById("totalTickets").innerText = stats.t; 
        document.getElementById("pendingTickets").innerText = stats.p; 
        document.getElementById("processTickets").innerText = stats.pr; 
        document.getElementById("closedTickets").innerText = stats.c;
    }

    function setQuickFilter(v) { currentQuickFilter = v; renderTable(allTickets); }
    function toggleChannelFilter(c, b) { currentChannelFilter = (currentChannelFilter === c) ? 'all' : c; renderTable(allTickets); }
    function applyFilters() { renderTable(allTickets); }

    const script = document.createElement('script');
    script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:handleGoogleResponse&gid=${SHEET_GID}`;
    document.body.appendChild(script);

    document.getElementById('ticketForm').onsubmit = function(e) {
        e.preventDefault(); 
        const btn = document.getElementById('submitBtn');
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; btn.disabled = true;
        fetch("https://script.google.com/macros/s/AKfycbzDRJpLUw51hZi3WI6Su7_LgeXz0GG-bK4CtfGygkmbfne2dMdtbVAVjD0NDmuEaL8v/exec", { 
            method: 'POST', body: new URLSearchParams(new FormData(this)), mode: 'no-cors' 
        }).then(() => location.reload());
    };
</script>
</body>
</html>
