<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CS Space : Dashboard v.0.5.37</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        /* üé® THEME VARIABLES SYSTEM */
        :root {
            --bg-body: #0f172a; 
            --bg-mesh: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.10) 0px, transparent 50%), 
                        radial-gradient(at 100% 0%, rgba(244, 63, 94, 0.10) 0px, transparent 50%);
            --sidebar-fixed: #1e293b; 
            --card-bg: rgba(30, 41, 59, 0.65);
            --card-border: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-secondary: #94a3b8;
            --primary-color: #f97316;
            --primary-glow: rgba(249, 115, 22, 0.3);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --link-color: #38bdf8; 
            --font-main: 'Inter', 'Kanit', sans-serif;
            --radius-md: 12px; 
            --radius-lg: 16px;
        }

        [data-theme="light"] {
            --bg-body: #f8fafc;
            --bg-mesh: radial-gradient(at 0% 0%, #fff7ed 0px, transparent 50%), 
                        radial-gradient(at 100% 0%, #ffedd5 0px, transparent 50%);
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-border: #e2e8f0;
            --text-main: #0f172a;
            --text-secondary: #64748b;
            --primary-color: #ea580c;
            --link-color: #0284c7; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg-body);
            background-image: var(--bg-mesh);
            background-attachment: fixed;
            background-size: cover;
            margin: 0; padding: 0;
            color: var(--text-main);
            height: 100vh;
            overflow: hidden; 
            transition: background-color 0.3s;
        }

        .app-container { display: flex; flex-direction: column; height: 100vh; width: 100vw; }

        .sidebar {
            margin: 16px 24px 0 24px; 
            border-radius: 24px;
            height: 68px; 
            background: var(--sidebar-fixed); 
            border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(12px);
            display: flex; flex-direction: row; align-items: center; justify-content: space-between;
            padding: 0 24px; flex-shrink: 0; z-index: 100; position: relative;
            color: #f8fafc; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .brand-area { font-size: 20px; font-weight: 700; color: #f8fafc; display: flex; align-items: center; gap: 6px; letter-spacing: -0.5px; white-space: nowrap; }
        .nav-group { display: flex; gap: 8px; align-items: center; }

        .nav-center {
            position: absolute; left: 50%; transform: translateX(-50%);
            display: flex; gap: 6px; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 99px; border: 1px solid rgba(255,255,255,0.05);
        }

        .nav-btn {
            background: transparent; border: none; width: auto; 
            padding: 6px 16px; border-radius: 99px; 
            color: #94a3b8; font-family: var(--font-main); font-weight: 500; font-size: 13px; cursor: pointer;
            display: flex; align-items: center; gap: 8px; transition: all 0.2s; text-align: center;
        }
        .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .nav-btn.active { background: var(--primary-color); color: white; box-shadow: 0 2px 10px var(--primary-glow); font-weight: 600; }

        .version-text { font-size: 11px; color: #64748b; font-weight: 500; margin-right: 12px; white-space: nowrap; }

        .icon-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); width: 32px; height: 32px; border-radius: 50%;
            color: #cbd5e1; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 15px;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.15); color: #fff; transform: rotate(15deg); }

        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        .compact-wrapper { max-width: 1250px; margin: 0 auto; width: 100%; }

        .page-header { margin-bottom: 15px; display: flex; align-items: center; justify-content: center; }
        .page-header h2 { font-size: 20px; font-weight: 700; margin: 0; letter-spacing: -0.5px; opacity: 0.9; }

        .page-view { display: none; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .page-view.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .dashboard-controls {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
            background: var(--card-bg); padding: 12px; border-radius: var(--radius-md); border: 1px solid var(--card-border); align-items: center;
            backdrop-filter: blur(20px); box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        
        .crm-filter-group { display: flex; gap: 8px; margin-bottom: 10px; width: 100%; justify-content: center; }
        .crm-filter-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--card-border); color: var(--text-secondary);
            padding: 8px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: 0.2s; font-size: 13px;
        }
        .crm-filter-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-main); }
        .crm-filter-btn.active { background: var(--info); color: white; border-color: transparent; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }

        .leaderboard-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .lb-card { padding: 15px; border-radius: var(--radius-md); color: white; cursor: pointer; transition: transform 0.2s; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.1); }
        .lb-card h3 { margin: 0 0 5px 0; font-size: 14px; }
        .lb-card .count { font-size: 24px; font-weight: 700; line-height: 1; }
        .lb-card:hover { transform: translateY(-3px); }
        
        .bg-gradient-1 { background: linear-gradient(135deg, #e11d48, #be123c); }
        .bg-gradient-2 { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
        .bg-gradient-3 { background: linear-gradient(135deg, #ea580c, #c2410c); }
        .bg-gradient-4 { background: linear-gradient(135deg, #ca8a04, #a16207); color: #fff; }
        
        .progress-track { background: rgba(0,0,0,0.2); height: 4px; width: 100%; border-radius: 4px; margin-top: 8px; overflow: hidden; }
        .progress-fill { background: rgba(255,255,255,0.9); height: 100%; border-radius: 4px; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-item { background: var(--card-bg); padding: 12px; border-radius: var(--radius-md); border: 1px solid var(--card-border); text-align: center; cursor: pointer; transition: 0.2s; backdrop-filter: blur(10px); }
        .stat-item:hover { border-color: var(--primary-color); transform: translateY(-2px); }
        .stat-item h4 { margin: 0; font-size: 10px; color: var(--text-secondary); text-transform: uppercase; font-weight: 700; }
        .stat-item .val { font-size: 22px; font-weight: 700; color: var(--text-main); margin-top: 4px; line-height: 1.2; }

        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .chart-card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius-lg); padding: 20px; height: 350px; display: flex; flex-direction: column; backdrop-filter: blur(10px); }
        .chart-title { font-size: 14px; font-weight: 600; color: var(--text-main); margin-bottom: 12px; }
        .chart-body { flex: 1; width: 100%; }

        .table-wrapper-center { max-width: 1250px; margin: 0 auto; width: 100%; }
        
        .table-container { 
            overflow-x: hidden; 
            background: var(--card-bg); 
            border-radius: var(--radius-lg); 
            border: 1px solid var(--card-border); 
            backdrop-filter: blur(10px); 
        }

        /* GLOBAL TABLE SETTINGS */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 12px; 
            table-layout: fixed; 
        }

        /* üî• FIX: Header single line, Data wraps nicely */
        th { 
            padding: 10px 8px; 
            text-align: left; 
            border-bottom: 1px solid var(--card-border);
            white-space: nowrap; /* Header ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥ */
            overflow: hidden;
            text-overflow: ellipsis; /* ‡∏ñ‡πâ‡∏≤‡∏•‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ... */
            vertical-align: middle;
        }

        td { 
            padding: 10px 8px; 
            text-align: left; 
            border-bottom: 1px solid var(--card-border);
            white-space: normal; /* Data ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏•‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ */
            word-wrap: break-word;
            overflow-wrap: break-word;
            vertical-align: top;
        } 
        
        /* üîß OPS101 (Main Dashboard) COLUMN WIDTHS */
        #mainTable th:nth-child(1) { width: 40px; text-align: center; } /* # */
        #mainTable th:nth-child(2) { width: 70px; } /* Ticket */
        #mainTable th:nth-child(3) { width: 80px; } /* Date */
        #mainTable th:nth-child(4) { width: 14%; } /* Customer */
        #mainTable th:nth-child(5) { width: 10%; } /* Model */
        #mainTable th:nth-child(6) { width: 18%; } /* Issue */
        #mainTable th:nth-child(7) { width: 18%; } /* Solution */
        #mainTable th:nth-child(8) { width: 80px; } /* Owner (Fixed: Expanded from 60px) */
        #mainTable th:nth-child(9) { width: 80px; } /* Urgency (Fixed: Expanded from 60px) */
        #mainTable th:nth-child(10) { width: 110px; } /* Status */
        #mainTable th:nth-child(11) { width: 100px; } /* Assignee */


        /* üîß CRM201 COLUMN WIDTHS - UPDATED for Sequence Number & Fix Overlap */
        #crmTable th:nth-child(1) { width: 40px; text-align: center; } /* # */
        #crmTable th:nth-child(2) { width: 80px; } /* Buy Date */
        #crmTable th:nth-child(3) { width: 100px; } /* Call Date */
        #crmTable th:nth-child(4) { width: 70px; text-align:center; } /* Owner */
        #crmTable th:nth-child(5) { width: 14%; } /* Name */
        #crmTable th:nth-child(6) { width: 90px; } /* Phone */
        #crmTable th:nth-child(7) { width: 14%; } /* Products */
        #crmTable th:nth-child(8) { width: 70px; text-align:right; } /* Total */
        #crmTable th:nth-child(9) { width: 80px; } /* Province */


        th { color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px; background: rgba(0,0,0,0.02); }
        tr:hover td { background: rgba(255,255,255,0.02); }
        [data-theme="light"] tr:hover td { background: rgba(0,0,0,0.02); }

        th:first-child, td:first-child { text-align: center; }

        .form-select, .form-input { width: 100%; height: 36px; padding: 0 10px; border-radius: 8px; border: 1px solid var(--card-border); background: rgba(255,255,255,0.03); color: var(--text-main); outline: none; font-family: var(--font-main); transition: 0.2s; font-size: 12px; }
        .form-select:focus, .form-input:focus { border-color: var(--primary-color); background: rgba(255,255,255,0.08); }
        [data-theme="light"] .form-select, [data-theme="light"] .form-input { background: #f1f5f9; border-color: #cbd5e1; }
        
        .input-label { display: block; font-size: 10px; margin-bottom: 4px; color: var(--text-secondary); font-weight: 600; }
        
        .btn-primary { background: var(--primary-color); color: white; border: none; padding: 0 16px; height: 32px; border-radius: 99px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 12px var(--primary-glow); transition: 0.2s; font-size: 12px; }
        .btn-primary:hover { transform: translateY(-1px); filter: brightness(1.1); }
        .btn-outline { background: transparent; border: 1px solid var(--card-border); color: var(--text-secondary); padding: 0 10px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 14px; }
        .btn-outline:hover { color: var(--text-main); border-color: var(--text-main); background: rgba(255,255,255,0.05); }

        .status-badge { padding: 4px 14px; border-radius: 99px; font-size: 11px; font-weight: 600; letter-spacing: 0.3px; white-space: nowrap; display: inline-block; }
        .status-closed { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }
        .status-doing { background: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.2); }
        .status-pending { background: rgba(148, 163, 184, 0.1); color: #94a3b8; border: 1px solid rgba(148, 163, 184, 0.2); }
        .status-assigned { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.2); }
        .urgent-badge { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 4px; box-shadow: 0 0 4px currentColor; }

        .click-to-copy { cursor: pointer; text-decoration: none; transition: all 0.2s; color: var(--link-color); font-weight: 600; position: relative; }
        .click-to-copy:hover { text-decoration: underline; filter: brightness(1.2); }
        .copy-toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.9); color: #fff; padding: 10px 20px; border-radius: 99px; font-weight: 600; display: none; z-index: 10000; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.5); font-size: 13px; pointer-events: none; animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        .ticker-wrap { width: 100%; overflow: hidden; height: 32px; background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.15); border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; }
        .ticker-content { white-space: nowrap; padding-left: 100%; display: inline-block; animation: ticker 30s linear infinite; color: var(--danger); font-weight: 600; font-size: 12px; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        @media (max-width: 1024px) {
            body { overflow: auto !important; height: auto !important; }
            .app-container { flex-direction: column; height: auto; min-height: 100vh; }
            .main-content { overflow: visible; height: auto; }
            .content-scroll { overflow: visible; height: auto; }
            .sidebar { height: auto; flex-wrap: wrap; padding: 12px 16px; gap: 8px; justify-content: space-between; margin: 10px; border-radius: 20px; }
            .nav-center { position: static; transform: none; background: transparent; border: none; padding: 0; width: 100%; justify-content: center; order: 3; margin-top: 5px; }
            .nav-btn { width: 100%; justify-content: center; background: rgba(255,255,255,0.05); }
            .version-text { display: none; } 
            .content-scroll { padding: 15px; }
            .compact-wrapper, .table-wrapper-center { width: 100%; max-width: 100%; }
            .summary-grid { grid-template-columns: 1fr; }
            .leaderboard-row, .stats-row { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .dashboard-controls { flex-direction: column; align-items: stretch; gap: 10px; }
            .lb-card, .stat-item { padding: 12px; }
            
            /* Mobile Scroll Override: Allow scroll on small screens if needed */
            .table-container { overflow-x: auto; }
            table { min-width: 600px; } 
        }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal-box { background: var(--bg-body); border: 1px solid var(--card-border); width: 90%; max-width: 500px; border-radius: var(--radius-lg); padding: 30px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="copyToast" class="copy-toast">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!</div>

<div class="app-container">
    
    <nav class="sidebar">
        <div class="brand-area">
            <span style="color:var(--primary-color)">CS</span> Space
        </div>
        
        <div class="nav-group nav-center">
            <button class="nav-btn active" onclick="switchPage('dashboard', this)">OPS101</button>
            <button class="nav-btn" onclick="switchPage('crm', this)">CRM201</button>
            <button class="nav-btn" onclick="switchPage('tec', this)">TEC301</button>
            <button class="nav-btn" onclick="switchPage('summary', this)">CS Summary</button>
        </div>
        
        <div class="nav-group" style="gap:10px;">
            <span id="countdown" class="version-text">v.0.5.37 ‚Ä¢ Loading...</span>
            <button class="btn-primary" onclick="openModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏™</button>
            <button class="icon-btn" onclick="toggleTheme()" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î">üåì</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="content-scroll">
            <div id="urgentTicker" class="ticker-wrap" style="display:none;">
                <div class="ticker-content" id="tickerContent"></div>
            </div>

            <div id="view-dashboard" class="page-view active">
                <div class="compact-wrapper">
                    <div class="leaderboard-row" id="leaderboard"></div>
                    <div class="stats-row">
                        <div class="stat-item" onclick="filterStatus('total-all')"><h4>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4><div class="val" id="val-total">0</div></div>
                        <div class="stat-item" onclick="filterStatus('all')"><h4>‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h4><div class="val" id="val-active" style="color:var(--primary-color)">0</div></div>
                        <div class="stat-item" onclick="filterStatus('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')"><h4>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h4><div class="val" id="val-pending">0</div></div>
                        <div class="stat-item" onclick="filterStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')"><h4>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h4><div class="val" id="val-doing">0</div></div>
                        <div class="stat-item" onclick="filterStatus('‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™')"><h4>‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™</h4><div class="val" id="val-closed" style="color:var(--success)">0</div></div>
                    </div>
                    <div class="dashboard-controls">
                        <div style="flex:2; min-width:200px;">
                            <input type="text" id="searchInput" class="form-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Ticket, ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." onkeyup="renderTable()">
                        </div>
                        <div style="flex:1; min-width:130px;"><input type="date" id="dateFilter" class="form-input" onchange="renderTable()"></div>
                        <div style="flex:1; min-width:130px;">
                            <select id="statusFilter" class="form-select" onchange="renderTable()">
                                <option value="total-all">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="all" selected>‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Active)</option>
                                <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™">‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™</option>
                            </select>
                        </div>
                        <div style="flex:1; min-width:130px;">
                            <select id="csFilter" class="form-select" onchange="renderTable()">
                                <option value="all">‡∏ó‡∏µ‡∏°: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="Best">Best</option>
                                <option value="Friend">Friend</option>
                                <option value="Ball">Ball</option>
                                <option value="Ohm">Ohm</option>
                            </select>
                        </div>
                        <button class="btn-outline" onclick="resetFilters()" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï" style="width:36px;">‚Ü∫</button>
                        <button class="btn-outline" onclick="exportCSV()" title="Export CSV" style="width:36px;">üì•</button>
                    </div>
                </div>
                <div class="table-wrapper-center">
                    <div class="table-container">
                        <table id="mainTable">
                            <thead>
                                <tr>
                                    <th>#</th><th>Ticket</th><th>Date</th><th>Customer</th><th>Model / Type</th>
                                    <th>Issue</th><th>Solution</th><th>CS Name</th><th>Urgency</th><th>Status</th><th>Assignee</th> 
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="view-crm" class="page-view">
                <div class="page-header"><h2>CRM201 : ‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</h2></div>
                <div class="compact-wrapper">
                    
                    <div class="crm-filter-group">
                        <button class="crm-filter-btn active" onclick="setCRMFilter(7, this)">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î 7 ‡∏ß‡∏±‡∏ô</button>
                        <button class="crm-filter-btn" onclick="setCRMFilter(30, this)">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î 30 ‡∏ß‡∏±‡∏ô</button>
                        <button class="crm-filter-btn" onclick="setCRMFilter(60, this)">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î 60 ‡∏ß‡∏±‡∏ô</button>
                        <button class="crm-filter-btn" onclick="setCRMFilter('all', this)">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>

                    <div class="dashboard-controls">
                        <div style="flex:1;">
                            <input type="text" id="crmSearch" class="form-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..." onkeyup="resetCRMAndRender()">
                        </div>
                        <div style="flex:1; min-width:130px;">
                            <select id="crmOwnerFilter" class="form-select" onchange="resetCRMAndRender()">
                                <option value="all">‡∏î‡∏π‡πÅ‡∏•‡πÇ‡∏î‡∏¢: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="Best">Best</option>
                                <option value="Friend">Friend</option>
                                <option value="Ball">Ball</option>
                                <option value="Ohm">Ohm</option>
                            </select>
                        </div>
                        <div style="flex:0 0 150px;">
                            <div class="stat-item" style="padding:4px 12px; height:36px; display:flex; align-items:center; justify-content:center; gap:8px;">
                                <h4 style="margin:0;">List Count</h4>
                                <div class="val" id="crm-total" style="font-size:16px; margin:0;">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="table-wrapper-center">
                        <div class="table-container">
                            <table id="crmTable">
                                <thead>
                                    </thead>
                                <tbody id="crmBody"></tbody>
                            </table>
                        </div>
                        <div style="text-align:center; margin-top:15px; margin-bottom:10px;">
                            <button id="crmLoadMoreBtn" class="btn-outline" style="width:auto; padding:8px 20px; display:none; margin:0 auto;" onclick="loadMoreCRM()">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-tec" class="page-view">
                <div class="page-header"><h2>TEC301</h2></div>
                <div class="compact-wrapper" style="display:flex; justify-content:center; align-items:center; height:300px; color:var(--text-secondary);">
                    <div style="text-align:center;">
                        <div style="font-size:40px; margin-bottom:10px;">üõ†Ô∏è</div>
                        <div>Coming Soon</div>
                    </div>
                </div>
            </div>

            <div id="view-summary" class="page-view">
                <div class="page-header"><h2>Analytics Summary</h2></div>
                <div class="compact-wrapper">
                    <div class="summary-grid">
                        <div class="chart-card"><div class="chart-title">üèÜ 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div><div id="chart_div" class="chart-body"></div></div>
                        <div class="chart-card"><div class="chart-title">üì¶ 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div><div id="chart_type_div" class="chart-body"></div></div>
                        <div class="chart-card"><div class="chart-title">üî• ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏™</div><div id="chart_urgent_div" class="chart-body"></div></div>
                        <div class="chart-card"><div class="chart-title">‚≠ê ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div><div id="chart_csat_div" class="chart-body"></div></div>
                        <div class="chart-card" style="grid-column: span 1;"><div class="chart-title">‚è±Ô∏è ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (‡∏Ñ‡∏ô/‡∏ô‡∏≤‡∏ó‡∏µ)</div><div id="chart_resp_div" class="chart-body"></div></div>
                    </div>
                </div>
            </div>

        </div>
    </main>
</div>

<div class="modal-overlay" id="addModal">
    <div class="modal-box">
        <h2 style="margin-top:0;">üìÇ ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà</h2>
        <form id="ticketForm" style="display:flex; flex-direction:column; gap:12px;">
            <div><label class="input-label">CS Name (‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö)</label>
            <select name="owner" class="form-select" required><option value="Best">Best</option><option value="Friend">Friend</option><option value="Ball">Ball</option><option value="Ohm">Ohm</option></select></div>
            <div><label class="input-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input name="customerName" class="form-input" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..."></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><label class="input-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select name="type" class="form-select"><option value="ICE">ICE</option><option value="COFFEE">COFFEE</option><option value="FUME">FUME</option><option value="BLENDER">BLENDER</option><option value="SODA">SODA</option><option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥</option><option value="‡∏õ‡∏±‡πä‡∏°‡∏î‡∏π‡∏î‡∏ô‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ñ‡∏±‡∏á">‡∏õ‡∏±‡πä‡∏°‡∏î‡∏π‡∏î‡∏ô‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ñ‡∏±‡∏á</option><option value="‡∏ï‡∏π‡πâ‡πÅ‡∏ä‡πà‡∏ô‡∏°">‡∏ï‡∏π‡πâ‡πÅ‡∏ä‡πà‡∏ô‡∏°</option></select></div>
                <div><label class="input-label">‡∏£‡∏∏‡πà‡∏ô</label><select name="model" class="form-select">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô --</option><option value="12A">12A</option><option value="12B">12B</option><option value="12C">12C</option><option value="15AF">15AF</option><option value="RoG600">RoG600</option><option value="S72C">S72C</option><option value="006C/H">006C/H</option><option value="S9C">S9C</option><option value="07S">07S</option><option value="38F">38F</option><option value="20AF">20AF</option><option value="120F">120F</option><option value="13F-W">13F-W</option><option value="P3B">P3B</option><option value="ProSoda">ProSoda</option><option value="Pro soda max">Pro soda max</option><option value="65S">65S</option><option value="45F">45F</option><option value="ROA4">ROA4</option><option value="U5">U5</option><option value="13F-PS">13F-PS</option><option value="220F">220F</option><option value="700xj">700xj</option><option value="FE 401">FE 401</option><option value="15SA">15SA</option><option value="13F-WB">13F-WB</option><option value="190F">190F</option><option value="20YLR">20YLR</option><option value="Blender">Blender</option><option value="ro-g600">ro-g600</option><option value="M7A">M7A</option><option value="RoA4">RoA4</option><option value="9CN">9CN</option><option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</option>
                </select></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><label class="input-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</label><select name="urgency" class="form-select"><option value="3.‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏ö">‡∏õ‡∏Å‡∏ï‡∏¥</option><option value="2.‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option><option value="1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å">üî• ‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option></select></div>
                <div><label class="input-label">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label><select name="channel" class="form-select"><option value="Line OA">Line OA</option><option value="Facebook">Facebook</option><option value="Shopee">Shopee</option><option value="‡πÇ‡∏ó‡∏£">‡πÇ‡∏ó‡∏£</option></select></div>
            </div>
            <div><label class="input-label">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</label><textarea name="issue" class="form-input" style="height:70px; padding-top:10px;"></textarea></div>
            <div><label class="input-label">‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label><textarea name="solution" class="form-input" style="height:50px; padding-top:10px;"></textarea></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button type="submit" class="btn-primary" style="flex:1; justify-content:center;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button type="button" class="btn-outline" style="flex:1; justify-content:center;" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </form>
    </div>
</div>

<script>
    google.charts.load('current', {'packages':['corechart']});
    
    // --- CONFIGS ---
    const MAIN_SHEET_ID = '1yP4soDSWwjomPVP3_udd2m3SZlm5j5XVo32tbKGvwdA', MAIN_GID = '816388223';
    // CRM Sheet Configuration
    const CRM_SHEET_ID = '1hJFF9j0fKoc-weDht_BWzhMfW7eTkZC6YQcIj36Pw58', CRM_GID = '1809457353';
    
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzDRJpLUw51hZi3WI6Su7_LgeXz0GG-bK4CtfGygkmbfne2dMdtbVAVjD0NDmuEaL8v/exec';

    let allTickets = [], filteredExport = [];
    let allCRM = []; // Store CRM data
    let currentCRMFilter = 7; // Default to 7 days
    let crmLimit = 10; // CRM: Limit items per load

    let countdownSec = 300;
    const savedTheme = localStorage.getItem('cs_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);

    function toggleTheme() {
        const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next); localStorage.setItem('cs_theme', next);
        drawChart(allTickets);
    }

    function switchPage(pageId, btn) {
        document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
        document.getElementById('view-' + pageId).classList.add('active');
        
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');

        // üî• Save Last Page to Local Storage
        localStorage.setItem('cs_last_page', pageId);
        
        const titles = {
            'dashboard': 'OPS101', 
            'crm': 'CRM201', 
            'tec': 'TEC301', 
            'summary': 'Analytics Summary'
        };
        const titleEl = document.getElementById('pageTitle');
        if(titleEl) titleEl.innerText = titles[pageId];

        if(pageId === 'summary') setTimeout(() => drawChart(allTickets), 100); 
    }

    function openModal() { document.getElementById('addModal').classList.add('open'); }
    function closeModal() { document.getElementById('addModal').classList.remove('open'); }
    function filterStatus(s) { document.getElementById('statusFilter').value = s; renderTable(); }
    
    function resetFilters() {
        document.getElementById('dateFilter').value = '';
        document.getElementById('statusFilter').value = 'all'; document.getElementById('csFilter').value = 'all';
        document.getElementById('searchInput').value = '';
        renderTable();
    }

    // CRM SPECIFIC FUNCTIONS
    function resetCRMAndRender() {
        crmLimit = 10;
        renderCRMTable();
    }

    function loadMoreCRM() {
        crmLimit += 10;
        renderCRMTable();
    }

    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            const t = document.getElementById('copyToast'); t.style.display = 'block'; 
            setTimeout(() => t.style.display = 'none', 2000);
        });
    }
    
    function formatLink(text) {
        if (!text || text === '-') return '-';
        text = String(text);
        if (text.toLowerCase().startsWith('http') || text.toLowerCase().startsWith('www')) {
            const url = text.toLowerCase().startsWith('www') ? 'http://' + text : text;
            return `<a href="${url}" target="_blank" style="color:var(--link-color); text-decoration:underline;">‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå</a>`;
        }
        return text;
    }

    setInterval(() => {
        if(countdownSec > 0) {
            countdownSec--;
            let m = Math.floor(countdownSec/60).toString().padStart(2,'0'), s = (countdownSec%60).toString().padStart(2,'0');
            document.getElementById('countdown').innerText = `v.0.5.37 ‚Ä¢ Refresh ${m}:${s}`;
        } else location.reload();
    }, 1000);

    // --- FETCH MAIN DATA (OPS101) ---
    const script1 = document.createElement('script');
    script1.src = `https://docs.google.com/spreadsheets/d/${MAIN_SHEET_ID}/gviz/tq?tqx=responseHandler:handleData&gid=${MAIN_GID}`;
    document.body.appendChild(script1);

    // --- FETCH CRM DATA (CRM201) ---
    const script2 = document.createElement('script');
    script2.src = `https://docs.google.com/spreadsheets/d/${CRM_SHEET_ID}/gviz/tq?tqx=responseHandler:handleCRM&gid=${CRM_GID}`;
    document.body.appendChild(script2);

    // Callback for OPS101
    window.handleData = (json) => {
        const rows = json.table.rows;
        allTickets = rows.map(r => {
            const v = (i) => (r.c[i] ? (r.c[i].f || r.c[i].v) : "-");
            return {
                id: v(0), date: v(1), owner: v(2), urgent: v(3), status: v(4), assignee: v(5),
                channel: v(6), customer: v(11), issue: v(20), solution: v(13), model: v(15), type: v(14),
                satisfaction: v(18), responseTime: v(19)
            };
        }).filter(x => x.id !== 'Ticket ID' && x.id !== '-');

        allTickets.sort((a,b) => {
            const pMap = {'1.‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å':1, '2.‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á':2, '3.‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏ö':3};
            const sMap = {'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£':1, '‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢':2, '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£':3, '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™':4};
            if(pMap[a.urgent] !== pMap[b.urgent]) return (pMap[a.urgent]||99) - (pMap[b.urgent]||99);
            return (sMap[a.status]||99) - (sMap[b.status]||99);
        });
        updateDashboard(); renderTable();
    };

    // Callback for CRM201
    window.handleCRM = (json) => {
        const rows = json.table.rows;
        allCRM = rows.map(r => {
            const v = (i) => (r.c[i] ? (r.c[i].f || r.c[i].v) : "-");
            return {
                date: v(0), platform: v(1), name: v(2), phone: v(3), items: v(4), 
                total: v(5), address: v(6), province: v(7), tracking: v(8),
                owner: v(11), // Column L (Index 11) -> Owner/Officer
                done7: v(12),  
                colP: v(15), colQ: v(16), // 7 Days Data (P,Q)
                done30: v(19), 
                colU: v(20), colV: v(21), // 30 Days Data (U,V)
                done60: v(24),
                colZ: v(25), colAA: v(26) // 60 Days Data (Z,AA)
            };
        }).filter(x => x.date !== '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤' && x.name !== '-');
        
        renderCRMTable();
    };

    function setCRMFilter(days, btn) {
        currentCRMFilter = days;
        document.querySelectorAll('.crm-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        resetCRMAndRender();
    }

    function calculateDueDate(dateStr, daysToAdd) {
        if (!dateStr) return null;
        const d = parseDateObj(dateStr);
        if (!d) return null;
        d.setDate(d.getDate() + parseInt(daysToAdd));
        return d;
    }

    function parseDateObj(str) {
        if (!str || str === '-') return null;
        str = String(str).trim(); 
        let d, m, y;
        if (str.toLowerCase().startsWith('date(')) {
            const nums = str.match(/\d+/g);
            if (nums && nums.length >= 3) { y = parseInt(nums[0]); m = parseInt(nums[1]) + 1; d = parseInt(nums[2]); }
        } else {
            const parts = str.split(' ')[0].split(/[\/\-\.]/);
            if (parts.length === 3) {
                if (parseInt(parts[0]) > 31) { y = parseInt(parts[0]); m = parseInt(parts[1])-1; d = parseInt(parts[2]); } 
                else { d = parseInt(parts[0]); m = parseInt(parts[1])-1; y = parseInt(parts[2]); }
            } else return null;
        }
        if (y > 2400) y -= 543;
        return new Date(y, m, d);
    }

    function formatDate(dateObj) {
        if (!dateObj) return "-";
        return `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`;
    }

    function renderCRMTable() {
        const thead = document.querySelector('#crmTable thead');
        const tbody = document.getElementById('crmBody'); 
        tbody.innerHTML = '';
        
        const ownerFilter = document.getElementById('crmOwnerFilter').value;

        // 1. HEADER LOGIC (ADDED Products, Total, Province to ALL VIEWS)
        let headers = `<tr><th>#</th><th>Buy Date</th><th>Call Date</th><th>CS Name</th><th>Customer Name</th><th>Phone</th>
        <th>Products</th><th>Total</th><th>Province</th>`;
        
        if (currentCRMFilter === 'all') {
            // Already added in base headers
        } else if (currentCRMFilter === 7) {
            headers += `<th>Detail</th><th>Link</th>`;
        } else if (currentCRMFilter === 30) {
            headers += `<th>Detail</th><th>Link</th>`;
        } else if (currentCRMFilter === 60) {
            headers += `<th>Detail</th><th>Link</th>`;
        }
        headers += `</tr>`;
        thead.innerHTML = headers;


        // 2. FILTER LOGIC
        const search = document.getElementById('crmSearch').value.toLowerCase();
        const today = new Date(); today.setHours(0,0,0,0);

        let displayData = allCRM.map(item => {
            let buyDate = parseDateObj(item.date);
            let targetDate = null;
            let daysDiff = 999;

            if(currentCRMFilter !== 'all') {
                targetDate = new Date(buyDate);
                targetDate.setDate(targetDate.getDate() + parseInt(currentCRMFilter));
                daysDiff = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            }
            return { ...item, targetDate, daysDiff, buyDateObj: buyDate };
        });

        const filtered = displayData.filter(t => {
            // Search Filter
            if(search && !JSON.stringify(t).toLowerCase().includes(search)) return false;
            
            // üî• Officer (Owner) Filter üî•
            if(ownerFilter !== 'all' && t.owner !== ownerFilter) return false;

            // üî• Content Check Logic (New v.0.5.34) üî•
            // Show only if there is a Link or Note (value is not '-')
            const hasData = (val) => val && String(val).trim() !== '-' && String(val).trim() !== '';

            if (currentCRMFilter === 7) {
                // Must have content in P or Q
                if (!hasData(t.colP) && !hasData(t.colQ)) return false;
            } else if (currentCRMFilter === 30) {
                // Must have content in U or V
                if (!hasData(t.colU) && !hasData(t.colV)) return false;
            } else if (currentCRMFilter === 60) {
                // Must have content in Z or AA
                if (!hasData(t.colZ) && !hasData(t.colAA)) return false;
            }

            return true;
        });

        // Sort
        filtered.sort((a,b) => {
            if (currentCRMFilter !== 'all') return (a.targetDate || 0) - (b.targetDate || 0);
            return (b.buyDateObj || 0) - (a.buyDateObj || 0);
        });

        document.getElementById('crm-total').innerText = filtered.length;

        if(filtered.length === 0) { tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:30px; opacity:0.5;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }

        if(filtered.length > crmLimit) {
            document.getElementById('crmLoadMoreBtn').style.display = 'inline-flex';
        } else {
            document.getElementById('crmLoadMoreBtn').style.display = 'none';
        }
        
        const itemsToShow = filtered.slice(0, crmLimit);

        itemsToShow.forEach((t, i) => {
            let callDateDisplay = "-";
            if (currentCRMFilter !== 'all' && t.targetDate) {
                 const dateStr = formatDate(t.targetDate);
                 callDateDisplay = `<span style="color:var(--text-secondary);">${dateStr}</span>`;
            }

            let rowHtml = `<tr>
                <td>${i+1}</td>
                <td>${t.date}</td>
                <td>${callDateDisplay}</td>
                <td><span class="status-badge status-assigned">${t.owner}</span></td>
                <td style="font-weight:600; color:var(--primary-color); cursor:pointer;" onclick="copyText('${t.name}')">${t.name}</td>
                <td style="cursor:pointer;" onclick="copyText('${t.phone}')">${t.phone}</td>
                <td style="font-size:11px;">${t.items}</td>
                <td style="text-align:right;">${t.total}</td>
                <td>${t.province}</td>`;

            // DYNAMIC COLUMNS
            if (currentCRMFilter === 'all') {
                // Already added base columns
            } else if (currentCRMFilter === 7) {
                rowHtml += `<td>${formatLink(t.colP)}</td><td>${formatLink(t.colQ)}</td>`;
            } else if (currentCRMFilter === 30) {
                rowHtml += `<td>${formatLink(t.colU)}</td><td>${formatLink(t.colV)}</td>`;
            } else if (currentCRMFilter === 60) {
                rowHtml += `<td>${formatLink(t.colZ)}</td><td>${formatLink(t.colAA)}</td>`;
            }

            rowHtml += `</tr>`;
            tbody.innerHTML += rowHtml;
        });
    }

    function updateDashboard() {
        const stats = { total:0, active:0, pending:0, doing:0, closed:0 };
        const team = { 'Best':{t:0,c:0}, 'Friend':{t:0,c:0}, 'Ball':{t:0,c:0}, 'Ohm':{t:0,c:0} };
        let tickerText = "";
        
        allTickets.forEach(t => {
            const isClosed = t.status.includes('‡∏õ‡∏¥‡∏î');
            stats.total++;
            if(isClosed) stats.closed++;
            else {
                stats.active++;
                if(t.status.includes('‡∏£‡∏≠')) stats.pending++; else stats.doing++;
            }
            if(team[t.owner]) { team[t.owner].t++; if(isClosed) team[t.owner].c++; }
            if(t.urgent.includes('1') && !isClosed) tickerText += `üî• [${t.id}] ${t.customer} (${t.issue}) &nbsp;&nbsp;&nbsp; `;
        });

        document.getElementById('val-total').innerText = stats.total;
        document.getElementById('val-active').innerText = stats.active;
        document.getElementById('val-pending').innerText = stats.pending;
        document.getElementById('val-doing').innerText = stats.doing;
        document.getElementById('val-closed').innerText = stats.closed;

        if(tickerText) { 
            document.getElementById('urgentTicker').style.display = 'flex'; 
            document.getElementById('tickerContent').innerHTML = tickerText; 
        } else {
            document.getElementById('urgentTicker').style.display = 'none';
        }

        const lb = document.getElementById('leaderboard'); lb.innerHTML = '';
        let i = 1;
        for(const [name, s] of Object.entries(team)) {
            const pct = s.t ? Math.round((s.c/s.t)*100) : 0;
            lb.innerHTML += `
            <div class="lb-card bg-gradient-${i}" onclick="document.getElementById('csFilter').value='${name}';renderTable()">
                <h3>${name}</h3>
                <div class="count">${s.t}</div>
                <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
                <div class="progress-label">${pct}% Closed</div>
            </div>`; 
            i++;
        }
        drawChart(allTickets);
    }

    function parseDate(str) {
        if (!str || str === '-' || str === '') return '';
        str = String(str).trim(); 
        let d, m, y;
        if (str.toLowerCase().startsWith('date(')) {
            const nums = str.match(/\d+/g);
            if (nums && nums.length >= 3) { y = parseInt(nums[0]); m = parseInt(nums[1]) + 1; d = parseInt(nums[2]); }
        } else {
            const datePart = str.split(' ')[0];
            const parts = datePart.split(/[\/\-\.]/);
            if (parts.length === 3) {
                if (parseInt(parts[0]) > 31) { y = parseInt(parts[0]); m = parseInt(parts[1]); d = parseInt(parts[2]); } 
                else { d = parseInt(parts[0]); m = parseInt(parts[1]); y = parseInt(parts[2]); }
            } else return '';
        }
        if (y > 2400) y -= 543;
        return `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
        const search = document.getElementById('searchInput').value.toLowerCase();
        const sFilter = document.getElementById('statusFilter').value;
        const cFilter = document.getElementById('csFilter').value;
        const dFilter = document.getElementById('dateFilter').value;

        const filtered = allTickets.filter(t => {
            if(dFilter) { const rowDate = parseDate(t.date); if(rowDate !== dFilter) return false; }
            if(sFilter !== 'total-all') {
                if(sFilter === 'all' && t.status.includes('‡∏õ‡∏¥‡∏î')) return false;
                if(sFilter === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && !t.status.includes('‡∏£‡∏≠')) return false;
                if(sFilter === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' && !t.status.includes('‡∏Å‡∏≥‡∏•‡∏±‡∏á') && !t.status.includes('‡∏°‡∏≠‡∏ö')) return false;
                if(sFilter === '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™' && !t.status.includes('‡∏õ‡∏¥‡∏î')) return false;
            }
            if(cFilter !== 'all' && t.owner !== cFilter) return false;
            if(search && !JSON.stringify(t).toLowerCase().includes(search)) return false;
            return true;
        });
        filteredExport = filtered; 
        if(filtered.length === 0) { tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:30px; opacity:0.5;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }

        filtered.forEach((t, i) => {
            const uCol = t.urgent.includes('1') ? '#ef4444' : (t.urgent.includes('2') ? '#f59e0b' : '#3b82f6');
            let sClass = 'status-pending'; 
            if(t.status.includes('‡∏õ‡∏¥‡∏î')) sClass = 'status-closed'; 
            else if(t.status.includes('‡∏Å‡∏≥‡∏•‡∏±‡∏á')) sClass = 'status-doing'; 
            else if(t.status.includes('‡∏°‡∏≠‡∏ö')) sClass = 'status-assigned';

            tbody.innerHTML += `<tr>
                <td>${i+1}</td><td style="font-weight:600; color:var(--primary-color)">${t.id}</td><td>${t.date}</td> 
                <td style="font-weight:600;"><span class="click-to-copy" onclick="copyText(this.innerText)">${t.customer}</span></td>
                <td><div>${t.model}</div><small style="opacity:0.6">${t.type}</small></td>
                <td>${t.issue}</td><td>${t.solution}</td><td>${t.owner}</td>
                <td><span class="urgent-badge" style="background:${uCol}"></span>${t.urgent.split('.')[1]||t.urgent}</td>
                <td><span class="status-badge ${sClass}">${t.status}</span></td><td>${t.assignee}</td>
            </tr>`;
        });
    }

    function drawChart(data) {
        if(!document.getElementById('view-summary').classList.contains('active')) return;
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const textStyle = { color: isDark ? '#94a3b8' : '#64748b', fontName:'Inter', fontSize:12 };
        const baseOpt = { backgroundColor: 'transparent', legend: { position: 'right', textStyle: textStyle }, chartArea: { left:10, top:20, width:'90%', height:'80%' }, pieSliceBorderColor: 'transparent', sliceVisibilityThreshold: 0 };

        const mCounts = {}; data.forEach(t => { if(t.model && t.model!=='-') mCounts[t.model] = (mCounts[t.model]||0)+1; });
        const mData = [['Model','Count']]; Object.entries(mCounts).sort((a,b)=>b[1]-a[1]).slice(0,10).forEach(x => mData.push(x));
        new google.visualization.PieChart(document.getElementById('chart_div')).draw(google.visualization.arrayToDataTable(mData), {...baseOpt, pieHole: 0.5});

        const tCounts = {}; data.forEach(t => { if(t.type && t.type!=='-') tCounts[t.type] = (tCounts[t.type]||0)+1; });
        const tData = [['Type','Count']]; Object.entries(tCounts).sort((a,b)=>b[1]-a[1]).slice(0,10).forEach(x => tData.push(x));
        new google.visualization.PieChart(document.getElementById('chart_type_div')).draw(google.visualization.arrayToDataTable(tData), {...baseOpt, pieHole: 0.5});

        const uCounts = {}; data.forEach(t => { if(t.urgent) { const label = t.urgent.split('.')[1] || t.urgent; uCounts[label] = (uCounts[label]||0)+1; } });
        const uData = [['Urgency','Count']]; Object.entries(uCounts).forEach(x => uData.push(x));
        new google.visualization.PieChart(document.getElementById('chart_urgent_div')).draw(google.visualization.arrayToDataTable(uData), {...baseOpt, pieHole: 0.5, colors: ['#ef4444', '#f59e0b', '#3b82f6']});

        const sCounts = {}; data.forEach(t => { const s = t.satisfaction || 'N/A'; sCounts[s] = (sCounts[s]||0)+1; });
        const sData = [['Rating','Count', { role: 'style' }]]; Object.entries(sCounts).sort().forEach(([k,v]) => sData.push([k, v, '#10b981']));
        new google.visualization.BarChart(document.getElementById('chart_csat_div')).draw(google.visualization.arrayToDataTable(sData), {...baseOpt, legend:'none', hAxis:{textStyle}, vAxis:{textStyle}});

        const csResp = {}; 
        data.forEach(t => { 
            const val = parseFloat(t.responseTime); const owner = t.owner;
            if(!isNaN(val) && owner && owner !== '-') { if(!csResp[owner]) csResp[owner] = { sum:0, count:0 }; csResp[owner].sum += val; csResp[owner].count++; }
        });
        const rData = [['CS Name','Avg Minutes', { role: 'style' }]]; 
        Object.entries(csResp).forEach(([k,v]) => { rData.push([k, parseFloat((v.count?v.sum/v.count:0).toFixed(2)), '#3b82f6']); });
        if (rData.length === 1) rData.push(['No Data', 0, '#3b82f6']);
        new google.visualization.ColumnChart(document.getElementById('chart_resp_div')).draw(google.visualization.arrayToDataTable(rData), {...baseOpt, legend:'none', hAxis:{textStyle}, vAxis:{textStyle}});
    }

    function exportCSV() {
        let csv = "ID,Date,Customer,Model,Issue,Solution,Owner,Urgency,Status,Assignee\n";
        filteredExport.forEach(r => csv += `"${r.id}","${r.date}","${r.customer}","${r.model}","${r.issue}","${r.solution}","${r.owner}","${r.urgent}","${r.status}","${r.assignee}"\n`);
        const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = "CS_Report.csv"; link.click();
    }

    document.getElementById('ticketForm').onsubmit = function(e) {
        e.preventDefault(); const btn = this.querySelector('button[type="submit"]'); btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; btn.disabled = true;
        fetch(SCRIPT_URL, { method: 'POST', body: new URLSearchParams(new FormData(this)), mode: 'no-cors' }).then(() => location.reload());
    };

    // üî• Restore Last Page on Load
    const lastPage = localStorage.getItem('cs_last_page');
    if (lastPage) {
        const btn = document.querySelector(`button[onclick="switchPage('${lastPage}', this)"]`);
        if(btn) switchPage(lastPage, btn);
    }
</script>
</body>
</html>
